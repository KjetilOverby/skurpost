import Head from "next/head";
import Link from "next/link";
import { api } from "~/utils/api";
import PostoppsettComponent from "~/components/postoppsett/PostoppsettComponent";
import { signIn, signOut, useSession } from "next-auth/react";
import RoleAdminMV from "~/components/roles/RoleAdminMV";

import HeaderComponent from "~/components/postoppsett/reusable/HeaderComponent";
import RoleAdmin from "~/components/roles/RoleAdmin";
import { PostInfoContext } from "~/components/context";
import { useContext, useEffect } from "react";
import LOGIN from "~/components/roles/Login";
import LoginPageNoRole from "~/components/index/LoginPageNoRole";
import StartPageRole from "~/components/index/StartPageRole";
import SaveSettingsWelcome from "~/components/index/SaveSettingsWelcome";

export default function Home({ colorMode }) {
  const { data: sessionData } = useSession();
  const { data: users } = api.users.getUsers.useQuery({});
  const context = useContext(PostInfoContext);
  const ctx = api.useContext();

  const { setGetUserInfo } = context;
  useEffect(() => {
    setGetUserInfo(sessionData && sessionData.user);
  }, [sessionData, setGetUserInfo]);

  const createSettings = api.settings.createPost.useMutation({
    onSuccess: () => {
      void ctx.settings.update.invalidate();
      void ctx.settings.getByUser.invalidate();
    },
  });

  const {
    data: posts,
    isLoading,
    error,
  } = api.settings.getByUser.useQuery({
    user: users?.[0].name,
    userId: users?.[0].id,
  });

  const handleCreate = async () => {
    try {
      const theme = "darkmode";
      const sawType = "mkv";
      const fonts = "";
      const visPakking = true;
      const visMiniListe = true;
      const response = await createSettings.mutateAsync({
        theme,
        fonts,
        sawType,
        visPakking,
        visMiniListe,
      });
      console.log(response);
    } catch (error) {
      console.error(error);
    }
  };

  return (
    <>
      <Head>
        <title>Skurpost</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      {sessionData ? (
        ""
      ) : (
        <div className="min-h-screen bg-white">
          <Link
            href={sessionData ? "/api/auth/signout" : "/api/auth/signin"}
            className="w-96 rounded-full bg-white/10 px-10 py-3 font-semibold no-underline transition hover:bg-white/20"
          >
            {sessionData ? "Sign out" : "Sign in"}
          </Link>
        </div>
      )}
      <RoleAdminMV>
        {posts && posts.userId === sessionData.user.id ? (
          <StartPageRole colorMode={colorMode} sessionData={sessionData} />
        ) : (
          <SaveSettingsWelcome handler={handleCreate} />
        )}
      </RoleAdminMV>
      <LOGIN>
        <LoginPageNoRole />
      </LOGIN>
    </>
  );
}
